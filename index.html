<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
		<title>Timeline of PHP versions</title>
		<script type="text/javascript" src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>                                                                                                                                              
		<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/moment.js/2.0.0/moment.min.js"></script>
		<style type="text/css">
		.tl {
			shape-rendering: geometricPrecision;
			stroke: gray;
			margin: 10px;
		}

		.tl .explorer
		{
			stroke: gray;
			fill: red;
		}

		.tl .explorer .panel
		{
			stroke: lightgray;
			fill: #fff;
		}

		.tl .explorer .eventOdd
		{
			opacity: 0.5;
		}

		.tl .explorer .lane0 {
			fill: lightgray;
			stroke: none;
		}

		.tl .explorer .lane1 {
			fill: lightgray;
			stroke: none;
		}

		.tl .explorer .lane2 {
			fill: lightgray;
			stroke: none;
		}

		.tl .explorer .lane3 {
			fill: lightgray;
			stroke: none;
		}

		.tl .explorer .lane4 {
			fill: lightgray;
			stroke: none;
		}

		.tl .explorer .lane5 {
			fill: lightgray;
			stroke: none;
		}

		.tl .viewver
		{
			stroke: none;
			fill: #000;
		}

		.tl .viewver .laneOdd
		{
			fill: #eee;
		}

		.tl .viewver .laneEven
		{
			fill: #fff;
		}

		.tl .viewver .laneLabel {
			fill: #000;
			font: 13px sans-serif;
		}

		.tl .viewver .legend .border {
			stroke: lightgray;
		}

		.tl .viewver .legend .year line {
			stroke: lightgray;
		}

		.tl .viewver .legend .year text {
			fill: #000;
			font: 9px sans-serif;
		}

		.tl .viewver .dead {
			fill: #d60003 !important;
			fill-opacity: 1.0 !important;
		}

		.tl .viewver .eventOdd {
			fill-opacity: 0.5;
		}

		.tl .viewver .lane0 {
			fill: #a3d600;
		}

		.tl .viewver .lane1 {
			fill: #00abd6;
		}

		.tl .viewver .lane2 {
			fill: #ff8d00;
		}

		.tl .viewver .lane3 {
			fill: #ffe600;
		}

		.tl .viewver .lane4 {
			fill: #ea00ff;
		}

		.tl .viewver .lane5 {
			fill: #1000ff;
		}

		.tl .viewver .cursor {
			fill: red;
			stroke: #000;
			font: 13px sans-serif;
		}

		.tl .viewver .cursor .line {
			stroke: red;
		}

		.tl .viewver .cursor .lane {
			stroke: none;
			fill: #000;
		}

		.tl .viewver .cursor .date {
			stroke: none;
			fill: #000;
			font: 9px sans-serif;
		}

		.tl .brush {
			stroke: gray;
			fill: dodgerblue;
			fill-opacity: .365;
		}
		</style>
	</head>
	<body>
		<script type="text/javascript">
		var data = [
			{"lane":"5.0","id":"5.0.0","start":1089721782,"end":1092227376},
			{"lane":"5.0","id":"5.0.1","start":1092313782,"end":1095856176},
			{"lane":"5.0","id":"5.0.2","start":1095942582,"end":1103030976},
			{"lane":"5.0","id":"5.0.3","start":1103117382,"end":1112185776},
			{"lane":"5.0","id":"5.0.4","start":1112272182,"end":1125836976},
			{"lane":"5.0","id":"5.0.5","start":1125923382,"end":null, "dead": true},
			{"lane":"5.1","id":"5.1.0","start":1132838982,"end":1133098176},
			{"lane":"5.1","id":"5.1.1","start":1133184582,"end":1136986176},
			{"lane":"5.1","id":"5.1.2","start":1137072582,"end":1146486576},
			{"lane":"5.1","id":"5.1.3","start":1146572982,"end":1146659376},
			{"lane":"5.1","id":"5.1.4","start":1146745782,"end":1155731376},
			{"lane":"5.1","id":"5.1.5","start":1155817782,"end":1156336176},
			{"lane":"5.1","id":"5.1.6","start":1156422582,"end":null, "dead": true},
			{"lane":"5.2","id":"5.2.0","start":1162474182,"end":1170854976},
			{"lane":"5.2","id":"5.2.1","start":1170941382,"end":1178108976},
			{"lane":"5.2","id":"5.2.2","start":1178195382,"end":1180528176},
			{"lane":"5.2","id":"5.2.3","start":1180614582,"end":1188390576},
			{"lane":"5.2","id":"5.2.4","start":1188476982,"end":1194442176},
			{"lane":"5.2","id":"5.2.5","start":1194528582,"end":1209558576},
			{"lane":"5.2","id":"5.2.6","start":1209644982,"end":1228310976},
			{"lane":"5.2","id":"5.2.7","start":1228397382,"end":1228656576},
			{"lane":"5.2","id":"5.2.8","start":1228742982,"end":1235568576},
			{"lane":"5.2","id":"5.2.9","start":1235654982,"end":1245241776},
			{"lane":"5.2","id":"5.2.10","start":1245328182,"end":1253017776},
			{"lane":"5.2","id":"5.2.11","start":1253104182,"end":1260970176},
			{"lane":"5.2","id":"5.2.12","start":1261056582,"end":1267018176},
			{"lane":"5.2","id":"5.2.13","start":1267104582,"end":1279715376},
			{"lane":"5.2","id":"5.2.14","start":1279801782,"end":1291728576},
			{"lane":"5.2","id":"5.2.15","start":1291814982,"end":1292419776},
			{"lane":"5.2","id":"5.2.16","start":1292506182,"end":1294234176},
			{"lane":"5.2","id":"5.2.17","start":1294320582,"end":null, "dead": true},
			{"lane":"5.3","id":"5.3.0","start":1246364982,"end":1258550976},
			{"lane":"5.3","id":"5.3.1","start":1258637382,"end":1267622976},
			{"lane":"5.3","id":"5.3.2","start":1267709382,"end":1279715376},
			{"lane":"5.3","id":"5.3.3","start":1279801782,"end":1291814976},
			{"lane":"5.3","id":"5.3.4","start":1291901382,"end":1294234176},
			{"lane":"5.3","id":"5.3.5","start":1294320582,"end":1300282176},
			{"lane":"5.3","id":"5.3.6","start":1300368582,"end":1313584176},
			{"lane":"5.3","id":"5.3.7","start":1313670582,"end":1314016176},
			{"lane":"5.3","id":"5.3.8","start":1314102582,"end":1326115776},
			{"lane":"5.3","id":"5.3.9","start":1326202182,"end":1328102976},
			{"lane":"5.3","id":"5.3.10","start":1328189382,"end":1335356976},
			{"lane":"5.3","id":"5.3.11","start":1335443382,"end":1335961776},
			{"lane":"5.3","id":"5.3.12","start":1336048182,"end":1336393776},
			{"lane":"5.3","id":"5.3.13","start":1336480182,"end":1338899376},
			{"lane":"5.3","id":"5.3.14","start":1338985782,"end":1342614576},
			{"lane":"5.3","id":"5.3.15","start":1342700982,"end":1345033776},
			{"lane":"5.3","id":"5.3.16","start":1345120182,"end":1347452976},
			{"lane":"5.3","id":"5.3.17","start":1347539382,"end":1350476976},
			{"lane":"5.3","id":"5.3.18","start":1350563382,"end":1353504576},
			{"lane":"5.3","id":"5.3.19","start":1353590982,"end":1355923776},
			{"lane":"5.3","id":"5.3.20","start":1356010182,"end":1358342976},
			{"lane":"5.3","id":"5.3.21","start":1358429382,"end":1361366976},
			{"lane":"5.3","id":"5.3.22","start":1361453382,"end":1363181376},
			{"lane":"5.3","id":"5.3.23","start":1363267782,"end":1365596976},
			{"lane":"5.3","id":"5.3.24","start":1365683382,"end":1368016176},
			{"lane":"5.3","id":"5.3.25","start":1368102582,"end":1370435376},
			{"lane":"5.3","id":"5.3.26","start":1370521782,"end":null},
			{"lane":"5.4","id":"5.4.0","start":1330608582,"end":1335356976},
			{"lane":"5.4","id":"5.4.1","start":1335443382,"end":1335961776},
			{"lane":"5.4","id":"5.4.2","start":1336048182,"end":1336393776},
			{"lane":"5.4","id":"5.4.3","start":1336480182,"end":1338899376},
			{"lane":"5.4","id":"5.4.4","start":1338985782,"end":1342614576},
			{"lane":"5.4","id":"5.4.5","start":1342700982,"end":1345033776},
			{"lane":"5.4","id":"5.4.6","start":1345120182,"end":1347452976},
			{"lane":"5.4","id":"5.4.7","start":1347539382,"end":1350476976},
			{"lane":"5.4","id":"5.4.8","start":1350563382,"end":1353504576},
			{"lane":"5.4","id":"5.4.9","start":1353590982,"end":1355923776},
			{"lane":"5.4","id":"5.4.10","start":1356010182,"end":1358342976},
			{"lane":"5.4","id":"5.4.11","start":1358429382,"end":1361366976},
			{"lane":"5.4","id":"5.4.12","start":1361453382,"end":1363181376},
			{"lane":"5.4","id":"5.4.13","start":1363267782,"end":1365596976},
			{"lane":"5.4","id":"5.4.14","start":1365683382,"end":1368016176},
			{"lane":"5.4","id":"5.4.15","start":1368102582,"end":1370435376},
			{"lane":"5.4","id":"5.4.16","start":1370521782,"end":null},
			{"lane":"5.5","id":"5.5.0","start":1371731382,"end":null}
		];

		var timeline = {};

		timeline.cursor = {};
		timeline.cursor.build = function(svg, viewver) {
			this.data = viewver.data;

			this.cursorArea = svg
				.append('g')
					.attr('x', viewver.laneLabelWidth)
					.attr('width', viewver.width)
					.attr('height', viewver.height)
					.attr('class', 'cursor')
			;

			this.cursor = this.cursorArea
				.append('g')
					.attr('width', viewver.width)
					.attr('height', viewver.height)
			;

			this.line = this.cursor
				.append('line')
					.attr('x1', 0)
					.attr('y1', 0)
					.attr('x2', 0)
					.attr('y2', viewver.height - viewver.legendHeight + ((viewver.legendHeight / 3)))
					.attr('class', 'line')
			;

			this.date = this.cursor
				.append('text')
				.attr('x', 5)
				.text(moment.unix(viewver.start).format('MMMM'))
				.attr('class', 'date')
			;

			this.date
				.attr('y', viewver.height - (viewver.legendHeight - (this.date.node().getBBox().height)))
			;

			var lanes = viewver.lanes.values();

			for (var i = 0; i < lanes.length; i++) {
				this.cursor
					.append("text")
						.attr('class', 'lane')
						.attr('id', 'lane' + i)
						.attr('x', 5)
						.attr("y", viewver.scaleY(i) + (viewver.laneHeight / 2))
						.attr('visibility', 'hidden')
				;
			}

			var cursorArea = this.cursorArea;
			var cursor = this.cursor;
			var date = this.date;

			d3.select(window).on('mousemove.timeline', function() {
					var mouse = d3.mouse(cursorArea.node());

					if (mouse[0] < cursorArea.attr('x') || mouse[0] > cursorArea.attr('width') || mouse[1] < 0 || mouse[1] > cursorArea.attr('height')) {
						cursorArea.attr('visibility', 'hidden');
						cursor.selectAll('text.lane').attr('visibility', 'hidden');
					} else {
						var currentDate = viewver.scaleX.invert(mouse[0]);

						date.text(moment.unix(currentDate).format('MMMM'));

						cursor.selectAll('text.lane').attr('visibility', 'hidden');

						viewver.events
							.selectAll('rect')
								.filter(function(d) { return (d.start < currentDate && (d.end == null || currentDate <= d.end)); })
									.each(function(d) {
											cursor
												.select('#lane' + viewver.lanes.values().indexOf(d.lane))
													.text(d.id)
													.attr('visibility', 'visible')
											;
										}
									)
						;

						cursor
							.attr("transform", "translate(" + mouse[0] + ", 0)")
							.selectAll('text')
								.each(function() {
									var length = this.getComputedTextLength();
									var x = 5;

									if (mouse[0] + length + 10 > viewver.width) {
										x = - length - 5;
									}

									d3.select(this).attr("x", x);
								}
							)
						;

						cursorArea.attr('visibility', 'visible');
					}
				}
			);

			return this;
		};

		timeline.viewver = {};
		timeline.viewver.build = function(svg, width, height, data, options) {
			if (!options.laneLabelWidth) options.laneLabelWidth = 40;
			if (!options.legendHeight) options.legendHeight = 40;

			this.width = width;
			this.height = height;
			this.laneLabelWidth = options.laneLabelWidth;
			this.legendHeight = options.legendHeight;

			this.g = svg.append('g')
				.attr('width', this.width)
				.attr('height', this.height)
				.attr('class', 'viewver')
			;

			this.data = data;
			this.start = timeline.getStart(this.data);
			this.end = timeline.getEnd(this.data);

			var lanes = d3.set();

			d3.values(data).forEach(function(d) {
					if (lanes.has(d.lane) === false) {
						lanes.add(d.lane);
					}
				}
			);

			this.lanes = lanes;
			this.laneHeight = (this.height - this.legendHeight) / this.lanes.values().length;

			this.scaleX = d3.scale.linear()
				.domain([ this.start, this.end ])
				.range([ this.laneLabelWidth, width ])
			;

			this.scaleY = d3.scale.linear()
				.domain([ 0, this.lanes.values().length ])
				.range([ 0, this.height - this.legendHeight ])
			;

			var lanes = this.lanes.values();

			for (var i = 0; i < lanes.length; i++) {
				var laneRow = this.g
					.append('g')
						.attr('transform', 'translate(0, ' + this.scaleY(i) + ')')
						.attr('width', this.width)
						.attr('height', this.laneHeight)
						.attr('class', 'lane' + (i %2 ? 'Odd' : 'Even'))
				;

				laneRow.append('rect')
						.attr('x', 0)
						.attr('y', 0)
						.attr('width', this.width)
						.attr('height', this.laneHeight)
				;

				laneRow
					.append('text')
						.text(lanes[i])
						.attr('class', 'laneLabel')
						.attr('x', 10)
						.attr('y', this.laneHeight / 2)
				;
			}

			this.g
				.append('clipPath')
					.attr('id', 'clip')
					.append('rect')
						.attr('x', this.laneLabelWidth)
						.attr('width', this.width - this.laneLabelWidth)
						.attr('height', this.height)
			;

			this.events = this.g
				.append('g')
					.attr("clip-path", "url(#clip)")
					.attr('x', this.laneLabelWidth)
					.attr('width', this.width)
					.attr('height', this.height)
					.attr('class', 'events')
			;

			this.legend = this.g
				.append('g')
					.attr("clip-path", "url(#clip)")
					.attr('width', this.width)
					.attr('height', height)
					.attr('class', 'legend')
			;

			this.legend
				.append('line')
					.attr('x1', this.width)
					.attr('y1', 0)
					.attr('x2', this.width)
					.attr('y2', this.legend.attr('height'))
					.attr('class', 'border')
			;

			this.legend
				.append('line')
					.attr('x1', this.laneLabelWidth)
					.attr('y1', 1)
					.attr('x2', this.width)
					.attr('y2', 1)
					.attr('class', 'border')
			;

			this.legend
				.append('line')
					.attr('x1', this.laneLabelWidth)
					.attr('y1', this.height - this.legendHeight)
					.attr('x2', this.width)
					.attr('y2', this.height - this.legendHeight)
					.attr('class', 'border')
			;

			this.legend
				.append('line')
					.attr('x1', this.laneLabelWidth)
					.attr('y1', this.height - ((this.legendHeight / 3) * 2))
					.attr('x2', this.width)
					.attr('y2', this.height - ((this.legendHeight / 3) * 2))
					.attr('class', 'border')
			;

			this.legend
				.append('line')
					.attr('x1', this.laneLabelWidth)
					.attr('y1', this.height)
					.attr('x2', this.width)
					.attr('y2', this.height)
					.attr('class', 'border')
			;

			this.cursor = timeline.cursor.build(this.g, this);

			this.display = function() {
				var startYear = moment.unix(this.start);
				var endYear = moment.unix(this.end);

				while (startYear.isBefore(endYear)) {
					var timestamp = startYear.format('X');
					var x = this.scaleX(timestamp);

					var year = this.legend
						.append('g')
							.attr('id', timestamp)
							.attr('class', 'year dynamic')
							.attr('transform', 'translate(' + x + ', 0)')
					;

					year
						.append('line')
							.attr('x1', 0)
							.attr('y1', 0)
							.attr('x2', 0)
							.attr('y2', this.legend.attr('height'))
					;

					year
						.append('text')
							.text(startYear.format('YYYY'))
							.attr('class', 'year')
							.attr('x', 10)
							.attr('y', height - 10)
					;

					startYear.add('years', 1);
				}

				var viewver = this;
				var cssClassGenerator = timeline.cssClassGenerator.build(this.lanes.values());

				this.events
					.selectAll('.event')
						.data(this.data)
								.enter()
									.append('rect')
										.attr('x', function(d) { return viewver.getEventX(d); })
										.attr('y', function(d) { return viewver.getEventY(d); })
										.attr('height', function(d) { return viewver.getEventHeight(d); }) 
										.attr('width', function(d) { return viewver.getEventWidth(d); })
										.attr('class', function(d) { return 'event ' + cssClassGenerator.getForEvent(d); })
				;
			};

			this.refresh = function(start, end) {
				this.start = start;
				this.end = end;
				this.scaleX.domain([ this.start, this.end ]);

				var rects = this.events.selectAll('rect');

				var viewver = this;

				this.events
					.selectAll('rect')
						.attr('x', function(d) { return viewver.getEventX(d); })
						.attr('width', function(d) { return viewver.getEventWidth(d); })
				;

				this.legend
					.selectAll('g.dynamic')
						.attr('transform', function() { return 'translate(' + viewver.scaleX(d3.select(this).attr('id')) + ', 0)'; })
				;
			};

			this.getEventX = function(event) {
				return this.scaleX(event.start);
			};

			this.getEventY = function(event) {
				return this.scaleY(this.lanes.values().indexOf(event.lane)) + (this.laneHeight - (this.laneHeight * 0.75)) / 2;
			};

			this.getEventWidth = function(event) {
				return this.scaleX(event.end) - this.scaleX(event.start);
			};

			this.getEventHeight = function(event) {
				return this.laneHeight * 0.75; 
			};

			return this;
		};

		timeline.explorer = {};
		timeline.explorer.bind = function(viewver) { this.viewver = viewver; return this; };
		timeline.explorer.build = function(svg, width, height, offsetX, offsetY, data) {
			this.width = width - offsetX;
			this.height = height;

			this.g = svg.append('g')
				.attr('transform', 'translate(' + offsetX + ', ' + offsetY + ')')
				.attr('width', this.width)
				.attr('height', this.height)
				.attr('class', 'explorer')
			;

			this.data = data;
			this.start = timeline.getStart(this.data);
			this.end = timeline.getEnd(this.data);

			var lanes = d3.set();

			d3.values(data).forEach(function(d) {
					if (lanes.has(d.lane) === false) {
						lanes.add(d.lane);
					}
				}
			);

			this.lanes = lanes;
			this.laneHeight = this.height / this.lanes.values().length;

			this.scaleX = d3.scale.linear()
				.domain([ this.start, this.end ])
				.range([ 0, this.width ])
			;

			this.scaleY = d3.scale.linear()
				.domain([ 0, this.lanes.values().length ])
				.range([ 0, this.height ])
			;

			var explorer = this;
			var cssClassGenerator = timeline.cssClassGenerator.build(this.lanes.values());

			this.g.append('rect')
				.attr('width', this.width)
				.attr('height', this.height)
				.attr('class', 'panel')
			;

			var explorer = this;

			this.brush = d3.svg.brush()
				.x(this.scaleX)
				.on('brush', function() {
						if (explorer.viewver) {
							var extent = explorer.brush.extent();
							
							explorer.viewver.refresh(extent[0], extent[1]);
						}
					}
				)
			;

			this.events = this.g.append('g');

			this.g.append('g')
				.attr('class', 'brush')
				.call(this.brush)
				.selectAll('rect')
					.attr('x', 0)
					.attr('y', 0)
					.attr('height', this.height)
			;

			this.display = function() {
				this.events
					.selectAll('.event')
						.data(this.data)
							.enter()
								.append('rect')
									.attr('x', function(d) { return explorer.getEventX(d); })
									.attr('y', function(d) { return explorer.getEventY(d); })
									.attr('height', function(d) { return explorer.getEventHeight(d); }) 
									.attr('width', function(d) { return explorer.getEventWidth(d); })
									.attr('class', function(d) { return cssClassGenerator.getForEvent(d); })
				;

				return this;
			};

			this.getEventX = function(event) {
				return this.scaleX(event.start);
			};

			this.getEventY = function(event) {
				return this.scaleY(this.lanes.values().indexOf(event.lane)) + (this.laneHeight - (this.laneHeight * 0.75)) / 2;
			};

			this.getEventWidth = function(event) {
				return this.scaleX(event.end) - this.scaleX(event.start); 
			};

			this.getEventHeight = function(event) {
				return this.laneHeight * 0.75; 
			};

			return this;
		};

		timeline.cssClassGenerator = {};
		timeline.cssClassGenerator.build = function(lanes) {
			this.index = 0;
			this.modulo = 0;
			this.lanes = lanes;;
			this.getForEvent = function(event) {
				var index = this.lanes.indexOf(event.lane);

				if (index != this.index) {
					this.modulo = 0;
					this.index = index;
				}

				var cssClass = 'lane' + index + ' ' + (this.modulo++ % 2 ? 'eventOdd' : 'eventEven');

				if (event.dead) {
					cssClass += ' dead';
				}

				return cssClass;
			};

			return this;
		};

		timeline.build = function (data, target, options) {
			if (!options.width) options.width = 960;
			if (!options.dataHeight) options.dataHeight = 400;
			if (!options.explorerHeight) options.explorerHeight = 100;
			if (!options.cssClass) options.cssClass = 'timeline';

			this.svg = d3.select(target)
				.append('svg')
					.attr('x', 0)
					.attr('y', 0)
					.attr('width', options.width)
					.attr('height', options.dataHeight + options.explorerHeight)
					.attr('class', options.cssClass)
			;

			this.viewver = timeline.viewver.build(this.svg, options.width, options.dataHeight, data, options.viewver ? options.viewver : {});
			this.explorer = timeline.explorer.build(this.svg, options.width, options.explorerHeight, this.viewver.laneLabelWidth, options.dataHeight, data, options.explorer ? options.explorer : {}).bind(this.viewver);

			this.display = function() {
				this.viewver.display();
				this.explorer.display();
			};

			return this.display();
		};

		timeline.getStart = function(data) {

			return moment.unix(d3.min(data, function(d) { return d.start; })).startOf('year').format('X');
		};

		timeline.getEnd = function(data) {
			var now = moment().format('X');
			return d3.max(data, function(d) { if (!d.end) d.end = now; return d.end; });
		};

		var phpTimeline = timeline.build(data, 'body', { cssClass: 'tl' });
		</script>
	</body>
</html>
