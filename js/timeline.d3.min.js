!function(t){"use strict";var e=t.timeline={};e.cursor={},e.cursor.build=function(t,e){this.data=e.data,this.cursorArea=t.append("g").attr("x",e.laneLabelWidth).attr("clip-path","url(#clip)").attr("width",e.width).attr("height",e.height).attr("class","cursor"),this.cursor=this.cursorArea.append("g").attr("width",e.width).attr("height",e.height),this.line=this.cursor.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",e.height-e.legendHeight+e.legendHeight/3).attr("class","line"),this.date=this.cursor.append("text").attr("x",5).text(moment.unix(e.start).format("MMMM")).attr("class","date"),this.date.attr("y",e.height-(e.legendHeight-this.date.node().getBBox().height));for(var i=e.lanes.values(),n=0;n<i.length;n++)this.cursor.append("text").attr("class","lane").attr("id","lane"+n).attr("x",5).attr("y",e.scaleY(n)+e.laneHeight/2).attr("visibility","hidden");var a=this.cursorArea,s=this.cursor,r=this.date;return d3.select(window).on("mousemove.timeline",function(){var t=d3.mouse(a.node()),i=e.scaleX.invert(t[0]);r.text(moment.unix(i).format("MMMM")),s.selectAll("text.lane").attr("visibility","hidden"),e.events.selectAll("rect").filter(function(t){return t.start<i&&(null==t.end||i<=t.end)}).each(function(t){s.select("#lane"+e.lanes.values().indexOf(t.lane)).text(t.id).attr("visibility","visible")}),s.attr("transform","translate("+t[0]+", 0)").selectAll("text").each(function(){var i=this.getComputedTextLength(),n=5;t[0]+i+10>e.width&&(n=-i-5),d3.select(this).attr("x",n)})}),this},e.viewver={},e.viewver.build=function(t,i,n,a,s){s.laneLabelWidth||(s.laneLabelWidth=40),s.legendHeight||(s.legendHeight=40),this.width=i,this.height=n,this.laneLabelWidth=s.laneLabelWidth,this.legendHeight=s.legendHeight,this.g=t.append("g").attr("width",this.width).attr("height",this.height).attr("class","viewver"),this.data=a,this.start=e.getStart(this.data),this.end=e.getEnd(this.data);var r=d3.set();d3.values(a).forEach(function(t){r.has(t.lane)===!1&&r.add(t.lane)}),this.lanes=r,this.laneHeight=(this.height-this.legendHeight)/this.lanes.values().length,this.scaleX=d3.scale.linear().domain([this.start,this.end]).range([this.laneLabelWidth,i]),this.scaleY=d3.scale.linear().domain([0,this.lanes.values().length]).range([0,this.height-this.legendHeight]);for(var r=this.lanes.values(),d=0;d<r.length;d++){var o=this.g.append("g").attr("transform","translate(0, "+this.scaleY(d)+")").attr("width",this.width).attr("height",this.laneHeight).attr("class","lane"+(d%2?"Odd":"Even"));o.append("rect").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.laneHeight),o.append("text").text(r[d]).attr("class","laneLabel").attr("x",10).attr("y",this.laneHeight/2)}return this.g.append("clipPath").attr("id","clip").append("rect").attr("x",this.laneLabelWidth).attr("width",this.width-this.laneLabelWidth).attr("height",this.height),this.events=this.g.append("g").attr("clip-path","url(#clip)").attr("x",this.laneLabelWidth).attr("width",this.width).attr("height",this.height).attr("class","events"),this.legend=this.g.append("g").attr("clip-path","url(#clip)").attr("width",this.width).attr("height",n).attr("class","legend"),this.legend.append("line").attr("x1",this.width).attr("y1",0).attr("x2",this.width).attr("y2",this.legend.attr("height")).attr("class","border"),this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",1).attr("x2",this.width).attr("y2",1).attr("class","border"),this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",this.height-this.legendHeight).attr("x2",this.width).attr("y2",this.height-this.legendHeight).attr("class","border"),this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",this.height-2*(this.legendHeight/3)).attr("x2",this.width).attr("y2",this.height-2*(this.legendHeight/3)).attr("class","border"),this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",this.height).attr("x2",this.width).attr("y2",this.height).attr("class","border"),this.cursor=e.cursor.build(this.g,this),this.display=function(){for(var t=moment.unix(this.start),i=moment.unix(this.end);t.isBefore(i);){var a=t.format("X"),s=this.scaleX(a),r=this.legend.append("g").attr("id",a).attr("class","year dynamic").attr("transform","translate("+s+", 0)");r.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",this.legend.attr("height")),r.append("text").text(t.format("YYYY")).attr("class","year").attr("x",10).attr("y",n-10),t.add("years",1)}var d=this,o=e.cssClassGenerator.build(this.lanes.values());this.events.selectAll(".event").data(this.data).enter().append("rect").attr("x",function(t){return d.getEventX(t)}).attr("y",function(t){return d.getEventY(t)}).attr("height",function(t){return d.getEventHeight(t)}).attr("width",function(t){return d.getEventWidth(t)}).attr("class",function(t){return"event "+o.getForEvent(t)})},this.refresh=function(t,e){this.start=t,this.end=e,this.scaleX.domain([this.start,this.end]),this.events.selectAll("rect");var i=this;this.events.selectAll("rect").attr("x",function(t){return i.getEventX(t)}).attr("width",function(t){return i.getEventWidth(t)}),this.legend.selectAll("g.dynamic").attr("transform",function(){return"translate("+i.scaleX(d3.select(this).attr("id"))+", 0)"})},this.getEventX=function(t){return this.scaleX(t.start)},this.getEventY=function(t){return this.scaleY(this.lanes.values().indexOf(t.lane))+(this.laneHeight-.75*this.laneHeight)/2},this.getEventWidth=function(t){return this.scaleX(t.end)-this.scaleX(t.start)},this.getEventHeight=function(){return.75*this.laneHeight},this},e.explorer={},e.explorer.bind=function(t){return this.viewver=t,this},e.explorer.build=function(t,i,n,a,s,r){this.width=i-a,this.height=n,this.g=t.append("g").attr("transform","translate("+a+", "+s+")").attr("width",this.width).attr("height",this.height).attr("class","explorer"),this.data=r,this.start=e.getStart(this.data),this.end=e.getEnd(this.data);var d=d3.set();d3.values(r).forEach(function(t){d.has(t.lane)===!1&&d.add(t.lane)}),this.lanes=d,this.laneHeight=this.height/this.lanes.values().length,this.scaleX=d3.scale.linear().domain([this.start,this.end]).range([0,this.width]),this.scaleY=d3.scale.linear().domain([0,this.lanes.values().length]).range([0,this.height]);var o=this,h=e.cssClassGenerator.build(this.lanes.values());this.g.append("rect").attr("width",this.width).attr("height",this.height).attr("class","panel");var o=this;return this.brush=d3.svg.brush().x(this.scaleX).on("brush",function(){if(o.viewver){var t=o.brush.extent();t[1]-t[0]>0&&o.viewver.refresh(t[0],t[1])}}),this.events=this.g.append("g"),this.g.append("g").attr("class","brush").call(this.brush).selectAll("rect").attr("x",0).attr("y",0).attr("height",this.height),this.display=function(){return this.events.selectAll(".event").data(this.data).enter().append("rect").attr("x",function(t){return o.getEventX(t)}).attr("y",function(t){return o.getEventY(t)}).attr("height",function(t){return o.getEventHeight(t)}).attr("width",function(t){return o.getEventWidth(t)}).attr("class",function(t){return h.getForEvent(t)}),this},this.getEventX=function(t){return this.scaleX(t.start)},this.getEventY=function(t){return this.scaleY(this.lanes.values().indexOf(t.lane))+(this.laneHeight-.75*this.laneHeight)/2},this.getEventWidth=function(t){return this.scaleX(t.end)-this.scaleX(t.start)},this.getEventHeight=function(){return.75*this.laneHeight},this},e.cssClassGenerator={},e.cssClassGenerator.build=function(t){return this.index=0,this.modulo=0,this.lanes=t,this.getForEvent=function(t){var e=this.lanes.indexOf(t.lane);e!=this.index&&(this.modulo=0,this.index=e);var i="lane"+e+" "+(this.modulo++%2?"eventOdd":"eventEven");return t.dead&&(i+=" dead"),i},this},e.build=function(t,i,n){return n||(n={}),n.width||(n.width=960),n.dataHeight||(n.dataHeight=400),n.explorerHeight||(n.explorerHeight=100),n.cssClass||(n.cssClass="timeline"),this.svg=d3.select(i).append("svg").attr("x",0).attr("y",0).attr("width",n.width).attr("height",n.dataHeight+n.explorerHeight).attr("class",n.cssClass),this.viewver=e.viewver.build(this.svg,n.width,n.dataHeight,t,n.viewver?n.viewver:{}),this.explorer=e.explorer.build(this.svg,n.width,n.explorerHeight,this.viewver.laneLabelWidth,n.dataHeight,t,n.explorer?n.explorer:{}).bind(this.viewver),this.display=function(){this.viewver.display(),this.explorer.display()},this.display()},e.getStart=function(t){return moment.unix(d3.min(t,function(t){return t.start})).startOf("year").format("X")},e.getEnd=function(t){var e=moment().format("X");return d3.max(t,function(t){return t.end||(t.end=e),t.end})}}(d3);
