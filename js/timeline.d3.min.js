(function(m){var b=m.timeline={};b.cursor={};b.cursor.build=function(e,c){this.data=c.data;this.cursorArea=e.append("g").attr("x",c.laneLabelWidth).attr("clip-path","url(#clip)").attr("width",c.width).attr("height",c.height).attr("class","cursor");this.cursor=this.cursorArea.append("g").attr("width",c.width).attr("height",c.height);this.line=this.cursor.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",c.height-c.legendHeight+c.legendHeight/3).attr("class","line");this.date=this.cursor.append("text").attr("x",
5).text(moment.unix(c.start).format("MMMM")).attr("class","date");this.date.attr("y",c.height-(c.legendHeight-this.date.node().getBBox().height));for(var a=c.lanes.values(),b=0;b<a.length;b++)this.cursor.append("text").attr("class","lane").attr("id","lane"+b).attr("x",5).attr("y",c.scaleY(b)+c.laneHeight/2).attr("visibility","hidden");var f=this.cursorArea,d=this.cursor,k=this.date;d3.select(window).on("mousemove.timeline",function(){var a=d3.mouse(f.node()),b=c.scaleX.invert(a[0]);k.text(moment.unix(b).format("MMMM"));
d.selectAll("text.lane").attr("visibility","hidden");c.events.selectAll("rect").filter(function(a){return a.start<b&&(null==a.end||b<=a.end)}).each(function(a){d.select("#lane"+c.lanes.values().indexOf(a.lane)).text(a.id).attr("visibility","visible")});d.attr("transform","translate("+a[0]+", 0)").selectAll("text").each(function(){var l=this.getComputedTextLength(),b=5;a[0]+l+10>c.width&&(b=-l-5);d3.select(this).attr("x",b)})});return this};b.viewver={};b.viewver.build=function(e,c,a,h,f){f.laneLabelWidth||
(f.laneLabelWidth=40);f.legendHeight||(f.legendHeight=40);this.width=c;this.height=a;this.laneLabelWidth=f.laneLabelWidth;this.legendHeight=f.legendHeight;this.g=e.append("g").attr("width",this.width).attr("height",this.height).attr("class","viewver");this.data=h;this.start=b.getStart(this.data);this.end=b.getEnd(this.data);var d=d3.set();d3.values(h).forEach(function(a){!1===d.has(a.lane)&&d.add(a.lane)});this.lanes=d;this.laneHeight=(this.height-this.legendHeight)/this.lanes.values().length;this.scaleX=
d3.scale.linear().domain([this.start,this.end]).range([this.laneLabelWidth,c]);this.scaleY=d3.scale.linear().domain([0,this.lanes.values().length]).range([0,this.height-this.legendHeight]);d=this.lanes.values();for(e=0;e<d.length;e++)c=this.g.append("g").attr("transform","translate(0, "+this.scaleY(e)+")").attr("width",this.width).attr("height",this.laneHeight).attr("class","lane"+(e%2?"Odd":"Even")),c.append("rect").attr("x",0).attr("y",0).attr("width",this.width).attr("height",this.laneHeight),
c.append("text").text(d[e]).attr("class","laneLabel").attr("x",10).attr("y",this.laneHeight/2);this.g.append("clipPath").attr("id","clip").append("rect").attr("x",this.laneLabelWidth).attr("width",this.width-this.laneLabelWidth).attr("height",this.height);this.events=this.g.append("g").attr("clip-path","url(#clip)").attr("x",this.laneLabelWidth).attr("width",this.width).attr("height",this.height).attr("class","events");this.legend=this.g.append("g").attr("clip-path","url(#clip)").attr("width",this.width).attr("height",
a).attr("class","legend");this.legend.append("line").attr("x1",this.width).attr("y1",0).attr("x2",this.width).attr("y2",this.legend.attr("height")).attr("class","border");this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",1).attr("x2",this.width).attr("y2",1).attr("class","border");this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",this.height-this.legendHeight).attr("x2",this.width).attr("y2",this.height-this.legendHeight).attr("class","border");this.legend.append("line").attr("x1",
this.laneLabelWidth).attr("y1",this.height-2*(this.legendHeight/3)).attr("x2",this.width).attr("y2",this.height-2*(this.legendHeight/3)).attr("class","border");this.legend.append("line").attr("x1",this.laneLabelWidth).attr("y1",this.height).attr("x2",this.width).attr("y2",this.height).attr("class","border");this.cursor=b.cursor.build(this.g,this);this.display=function(){for(var c=moment.unix(this.start),e=moment.unix(this.end);c.isBefore(e);){var d=c.format("X"),l=this.scaleX(d),d=this.legend.append("g").attr("id",
d).attr("class","year dynamic").attr("transform","translate("+l+", 0)");d.append("line").attr("x1",0).attr("y1",0).attr("x2",0).attr("y2",this.legend.attr("height"));d.append("text").text(c.format("YYYY")).attr("class","year").attr("x",10).attr("y",a-10);c.add("years",1)}var f=this,h=b.cssClassGenerator.build(this.lanes.values());this.events.selectAll(".event").data(this.data).enter().append("rect").attr("x",function(a){return f.getEventX(a)}).attr("y",function(a){return f.getEventY(a)}).attr("height",
function(a){return f.getEventHeight(a)}).attr("width",function(a){return f.getEventWidth(a)}).attr("class",function(a){return"event "+h.getForEvent(a)})};this.refresh=function(a,c){this.start=a;this.end=c;this.scaleX.domain([this.start,this.end]);this.events.selectAll("rect");var b=this;this.events.selectAll("rect").attr("x",function(a){return b.getEventX(a)}).attr("width",function(a){return b.getEventWidth(a)});this.legend.selectAll("g.dynamic").attr("transform",function(){return"translate("+b.scaleX(d3.select(this).attr("id"))+
", 0)"})};this.getEventX=function(a){return this.scaleX(a.start)};this.getEventY=function(a){return this.scaleY(this.lanes.values().indexOf(a.lane))+(this.laneHeight-0.75*this.laneHeight)/2};this.getEventWidth=function(a){return this.scaleX(a.end)-this.scaleX(a.start)};this.getEventHeight=function(a){return 0.75*this.laneHeight};return this};b.explorer={};b.explorer.bind=function(b){this.viewver=b;return this};b.explorer.build=function(e,c,a,h,f,d){this.width=c-h;this.height=a;this.g=e.append("g").attr("transform",
"translate("+h+", "+f+")").attr("width",this.width).attr("height",this.height).attr("class","explorer");this.data=d;this.start=b.getStart(this.data);this.end=b.getEnd(this.data);var k=d3.set();d3.values(d).forEach(function(a){!1===k.has(a.lane)&&k.add(a.lane)});this.lanes=k;this.laneHeight=this.height/this.lanes.values().length;this.scaleX=d3.scale.linear().domain([this.start,this.end]).range([0,this.width]);this.scaleY=d3.scale.linear().domain([0,this.lanes.values().length]).range([0,this.height]);
var g=this,m=b.cssClassGenerator.build(this.lanes.values());this.g.append("rect").attr("width",this.width).attr("height",this.height).attr("class","panel");g=this;this.brush=d3.svg.brush().x(this.scaleX).on("brush",function(){if(g.viewver){var a=g.brush.extent();0<a[1]-a[0]&&g.viewver.refresh(a[0],a[1])}});this.events=this.g.append("g");this.g.append("g").attr("class","brush").call(this.brush).selectAll("rect").attr("x",0).attr("y",0).attr("height",this.height);this.display=function(){this.events.selectAll(".event").data(this.data).enter().append("rect").attr("x",
function(a){return g.getEventX(a)}).attr("y",function(a){return g.getEventY(a)}).attr("height",function(a){return g.getEventHeight(a)}).attr("width",function(a){return g.getEventWidth(a)}).attr("class",function(a){return m.getForEvent(a)});return this};this.getEventX=function(a){return this.scaleX(a.start)};this.getEventY=function(a){return this.scaleY(this.lanes.values().indexOf(a.lane))+(this.laneHeight-0.75*this.laneHeight)/2};this.getEventWidth=function(a){return this.scaleX(a.end)-this.scaleX(a.start)};
this.getEventHeight=function(a){return 0.75*this.laneHeight};return this};b.cssClassGenerator={};b.cssClassGenerator.build=function(b){this.modulo=this.index=0;this.lanes=b;this.getForEvent=function(c){var a=this.lanes.indexOf(c.lane);a!=this.index&&(this.modulo=0,this.index=a);a="lane"+a+" "+(this.modulo++%2?"eventOdd":"eventEven");c.dead&&(a+=" dead");return a};return this};b.build=function(e,c,a){a||(a={});a.width||(a.width=960);a.dataHeight||(a.dataHeight=400);a.explorerHeight||(a.explorerHeight=
100);a.cssClass||(a.cssClass="timeline");this.svg=d3.select(c).append("svg").attr("x",0).attr("y",0).attr("width",a.width).attr("height",a.dataHeight+a.explorerHeight).attr("class",a.cssClass);this.viewver=b.viewver.build(this.svg,a.width,a.dataHeight,e,a.viewver?a.viewver:{});this.explorer=b.explorer.build(this.svg,a.width,a.explorerHeight,this.viewver.laneLabelWidth,a.dataHeight,e,a.explorer?a.explorer:{}).bind(this.viewver);this.display=function(){this.viewver.display();this.explorer.display()};
return this.display()};b.getStart=function(b){return moment.unix(d3.min(b,function(b){return b.start})).startOf("year").format("X")};b.getEnd=function(b){var c=moment().format("X");return d3.max(b,function(a){a.end||(a.end=c);return a.end})}})(d3);
